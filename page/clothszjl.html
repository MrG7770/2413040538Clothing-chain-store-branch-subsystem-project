<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>服装店收支记录管理</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css" media="all">
  <link rel="stylesheet" href="../css/layuimini.css" media="all">
</head>

<body>
  <div class="layui-form layui-form-pane" style="margin: 10px;">
    <div class="layui-form-item">
      <label class="layui-form-label">记录编号</label>
      <div class="layui-input-inline">
        <input type="text" name="recordId" placeholder="请输入记录编号" autocomplete="off" class="layui-input">
      </div>
      <label class="layui-form-label">收支类型</label>
      <div class="layui-input-inline">
        <select name="recordType">
          <option value="">全部类型</option>
          <option value="收入">收入</option>
          <option value="支出">支出</option>
        </select>
      </div>
      <label class="layui-form-label">日期范围</label>
      <div class="layui-input-inline">
        <input type="text" name="dateRange" placeholder="请选择日期范围" autocomplete="off" class="layui-input" id="dateRange">
      </div>
      <label class="layui-form-label">交易类型</label>
      <div class="layui-input-inline">
        <select name="transactionType">
          <option value="">全部交易</option>
          <option value="销售服装">销售服装</option>
          <option value="进货成本">进货成本</option>
          <option value="店面租金">店面租金</option>
          <option value="水电费">水电费</option>
          <option value="员工工资">员工工资</option>
          <option value="其他收入">其他收入</option>
          <option value="其他支出">其他支出</option>
        </select>
      </div>
      <div class="layui-input-inline">
        <button class="layui-btn layui-btn-normal" lay-submit lay-filter="search">搜索</button>
      </div>
    </div>
  </div>
  <div>
    <!-- 工具栏设置： 添加记录、批量删除、统计分析 -->
    <script type="text/html" id="financialTableToolbar">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-normal layui-btn-sm data-add-btn" lay-event="add"> 新增记录 </button>
        <button class="layui-btn layui-btn-sm layui-btn-danger data-delete-btn" lay-event="delete"> 批量删除 </button>
        <button class="layui-btn layui-btn-sm layui-btn-primary" lay-event="export"> 导出数据 </button>
        <button class="layui-btn layui-btn-sm layui-btn-success" lay-event="analysis"> 统计分析 </button>
      </div>
    </script>

    <!-- 数据表格定义 -->
    <table class="layui-hide" id="financialTable" lay-filter="financialTableFilter"></table>

    <!--收支类型列-->
    <script type="text/html" id="recordType">
      {{#  if(d.type === '收入'){ }}
      <span class="layui-badge layui-bg-green">收入</span>
      {{#  } else { }}
      <span class="layui-badge layui-bg-red">支出</span>
      {{#  } }}
    </script>

    <!-- 定义表格最后一列：操作 -->
    <script type="text/html" id="financialTableOperation">
      <a class="layui-btn  layui-btn-xs data-count-edit" lay-event="edit">编辑</a>
      <a class="layui-btn layui-btn-xs layui-btn-danger data-count-delete" lay-event="delete">删除</a>
      <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="detail">详情</a>
    </script>
  </div>
  <script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
  <script>
    // 使用Layui的表单、表格、日期和弹窗模块
    layui.use(['form', 'table', 'layer', 'laydate'], function () {
      var $ = layui.jquery;
      var form = layui.form;
      var table = layui.table;
      var layer = layui.layer;
      var laydate = layui.laydate;
      var tableData = []; // 存储表格数据
      var originalData = []; // 存储原始数据用于恢复

      // 渲染日期范围选择器
      laydate.render({
        elem: '#dateRange'
        ,range: true // 开启左右日期选择
        ,format: 'yyyy-MM-dd'
      });

      // 渲染表格，保存表格实例以便重载
      var tableIns = table.render({
        elem: '#financialTable',
        url: 'szjl.json',  // 收支数据文件
        toolbar: '#financialTableToolbar',
        defaultToolbar: ['filter', 'exports', 'print', {
          title: '提示',
          layEvent: 'LAYTABLE_TIPS',
          icon: 'layui-icon-tips'
        }],
        cols: [[
          { type: "checkbox", width: 50 },
          { field: 'recordId', width: 120, title: '记录编号', sort: true },
          { field: 'type', width: 100, title: '收支类型', templet: '#recordType', align: "center", sort: true },
          { field: 'transactionType', width: 120, title: '交易类型', sort: true },
          { field: 'amount', width: 120, title: '金额(元)', sort: true, 
            templet: function(d) {
              return d.type === '收入' ? '<span style="color: green;">+' + d.amount + '</span>' : 
                                         '<span style="color: red;">-' + d.amount + '</span>';
            }
          },
          { field: 'date', width: 150, title: '交易日期', sort: true },
          { field: 'paymentMethod', width: 120, title: '支付方式' },
          { field: 'handler', width: 100, title: '经手人', sort: true },
          { field: 'remark', width: 200, title: '备注' },
          { title: '操作', minWidth: 240, toolbar: '#financialTableOperation', align: "center" }
        ]],
        limits: [10, 15, 20, 25, 50, 100],
        limit: 15,
        page: true,
        skin: 'line',
        done: function (res) {
          // 保存表格数据到本地变量
          tableData = JSON.parse(JSON.stringify(res.data));
          originalData = JSON.parse(JSON.stringify(res.data)); // 深拷贝保存原始数据
        }
      });

      // 搜索表单监听
      form.on('submit(search)', function (data) {
        // 显示加载层，提示用户正在搜索
        var loadingIndex = layer.load(2, {
          shade: [0.1, '#fff']
        });

        // 执行表格重载，传递搜索条件
        tableIns.reload({
          where: data.field, // 搜索的条件
          page: {
            curr: 1 // 重新从第1页开始
          },
          done: function (res, curr, count) {
            // 关闭加载层
            layer.close(loadingIndex);
            // 更新本地数据
            tableData = JSON.parse(JSON.stringify(res.data));
            originalData = JSON.parse(JSON.stringify(res.data));
            // 弹出最终的搜索信息，格式化为JSON字符串
            layer.open({
              title: '搜索条件',
              content: JSON.stringify(data.field, null, 2),
              btn: ['确定'],
              btnAlign: 'c',
              shade: 0.1,
              area: ['400px', 'auto']
            });
          }
        });
        return false;
      });

      /**
       * toolbar监听事件（工具栏监听事件）
       */
      table.on('toolbar(financialTableFilter)', function (obj) {
        console.log("工具栏事件:", obj.event); // 调试信息
        
        if (obj.event === 'add') {  // 监听添加操作
          var index = layer.open({
            title: '新增收支记录',
            type: 2,
            shade: 0.2,
            maxmin: true,
            shadeClose: true,
            area: ['100%', '100%'],
            content: '../page/createszjl.html'  // 新增收支记录页面路径
          });
          $(window).on("resize", function () {
            layer.full(index);
          });
        } else if (obj.event === 'delete') {  // 监听批量删除操作
          // 使用表格ID获取选中状态
          var checkStatus = table.checkStatus('financialTable');
          console.log("选中状态:", checkStatus); // 调试信息
          
          var selectedData = checkStatus.data;
          
          if (selectedData.length === 0) {
            layer.msg('请选择需要删除的记录');
            return;
          }
          
          // 确认删除
          layer.confirm('确定要删除选中的 ' + selectedData.length + ' 条记录吗？', { icon: 3 }, function (index) {
            // 使用字符串比较确保ID匹配正确
            var selectedIds = selectedData.map(item => String(item.recordId));
            
            console.log("待删除ID:", selectedIds); // 调试信息
            console.log("当前数据:", tableData.map(item => String(item.recordId))); // 调试信息
            
            // 过滤数据
            tableData = tableData.filter(item => !selectedIds.includes(String(item.recordId)));
            
            console.log("删除后剩余数据:", tableData.length); // 调试信息
            
            // 重新渲染表格
            tableIns.reload({
              data: tableData,
              url: null, // 确保使用本地数据而非重新请求
              page: {
                curr: 1 // 重置到第一页
              }
            });
            
            layer.close(index);
            layer.msg('删除成功，共删除 ' + selectedData.length + ' 条记录');
          });
        } else if (obj.event === 'export') {  // 导出数据
          layer.confirm('确定要导出所有收支数据吗？', { icon: 3 }, function (index) {
            layer.close(index);
            layer.msg('正在导出收支数据，请稍候...');
            // 这里添加导出逻辑
          });
        } else if (obj.event === 'analysis') {  // 统计分析
          layer.open({
            title: '收支统计分析',
            type: 2,
            shade: 0.2,
            maxmin: true,
            shadeClose: true,
            area: ['80%', '80%'],
            content: './page/financialAnalysis.html'  // 统计分析页面路径
          });
        }
      });

      // 监听表格复选框选择
      table.on('checkbox(financialTableFilter)', function (obj) {
        console.log("复选框选择:", obj);
      });

      // 监听表格最后一列的操作
      table.on('tool(financialTableFilter)', function (obj) {
        var data = obj.data;
        if (obj.event === 'detail') {
          var index = layer.open({
            title: '收支详情 - ' + data.recordId,
            type: 2,
            shade: 0.2,
            maxmin: true,
            shadeClose: true,
            area: ['100%', '100%'],
            content: './page/financialDetail.html?id=' + data.recordId
          });
          $(window).on("resize", function () {
            layer.full(index);
          });
          return false;
        } else if (obj.event == 'edit') {
          var index = layer.open({
            title: '编辑收支记录 - ' + data.recordId,
            type: 2,
            shade: 0.2,
            maxmin: true,
            shadeClose: true,
            area: ['100%', '100%'],
            content: '../page/editorszjl.html?id=' + data.recordId
          });
          $(window).on("resize", function () {
            layer.full(index);
          });
          return false;
        } else if (obj.event == 'delete') {
          layer.confirm('您确认删除该收支记录吗？', { icon: 3 }, function (index) {
            obj.del();
            // 更新本地数据
            tableData = tableData.filter(item => String(item.recordId) !== String(data.recordId));
            layer.close(index);
            layer.msg('收支记录删除成功');
          });
        }
      });
    });
  </script>
</body>

</html>
    
